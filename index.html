<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>최혁진과의 약속잡기</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --ink: #1b1b1f;
      --muted: #5f6472;
      --accent: #3a86ff;
      --accent-2: #8338ec;
      --border: #e3e8f0;
      --shadow: 0 20px 45px rgba(40, 63, 107, 0.15);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans KR", "Segoe UI", "Apple SD Gothic Neo", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 10% 20%, rgba(58, 134, 255, 0.12), transparent 25%),
                  radial-gradient(circle at 90% 10%, rgba(131, 56, 236, 0.12), transparent 22%),
                  linear-gradient(180deg, #f8fbff 0%, #eef2f8 100%);
    }
    .page { max-width: 1100px; margin: 0 auto; padding: 32px 24px 56px; }
    .hero { margin-bottom: 18px; }
    .kicker { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 999px; background: rgba(58, 134, 255, 0.1); color: var(--accent); font-weight: 700; font-size: 13px; letter-spacing: 0.4px; }
    h1 { margin: 10px 0 4px; font-size: 32px; letter-spacing: -0.5px; }
    .lede { margin: 0; color: var(--muted); font-size: 16px; }
    .notice { background: rgba(255, 255, 255, 0.8); border: 1px solid var(--border); border-radius: 14px; padding: 16px 18px; box-shadow: var(--shadow); margin-bottom: 18px; }
    .notice h2 { margin: 0 0 6px; font-size: 16px; }
    .notice ul { margin: 0; padding-left: 18px; color: var(--muted); line-height: 1.6; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 22px;
      padding: 24px;
    }
    .form-area { display: flex; flex-direction: column; gap: 14px; }
    .field { display: flex; flex-direction: column; gap: 6px; font-weight: 600; }
    .field input {
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fbff;
      font-size: 15px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
      font-weight: 600;
    }
    .field input[type="date"] {
      font-weight: 700;
      letter-spacing: 0.6px;
      color: #0f172a;
    }
    .field input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.16); }
    .hint { color: var(--muted); font-weight: 400; margin: 0; font-size: 13px; }

    .times-area { display: flex; flex-direction: column; gap: 12px; }
    .times-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .tag { padding: 6px 10px; background: rgba(131, 56, 236, 0.1); color: var(--accent-2); border-radius: 999px; font-weight: 700; font-size: 13px; }
    .day-label { color: var(--muted); font-weight: 600; }

    .time-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
    .time-grid button {
      padding: 12px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f7f9fc;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    .time-grid button:hover { border-color: var(--accent); box-shadow: 0 10px 20px rgba(58, 134, 255, 0.12); transform: translateY(-1px); }
    .time-grid button.selected { border-color: var(--accent); background: rgba(58, 134, 255, 0.12); color: var(--ink); font-weight: 700; }
    .time-grid button.reserved { background: #f2f3f7; color: #9297a3; border-style: dashed; cursor: not-allowed; }
    .time-grid button.lunch { background: #fff5e9; color: #b26a00; border-style: dashed; cursor: not-allowed; }
    .time-grid button:disabled { box-shadow: none; transform: none; }

    button#reserveBtn {
      padding: 13px 14px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    button#reserveBtn:hover { box-shadow: 0 12px 26px rgba(58, 134, 255, 0.28); transform: translateY(-1px); }

    .status { min-height: 22px; font-weight: 700; }
    .status.success { color: #1e8a3e; }
    .status.error { color: #c81e1e; }

    .empty-state { padding: 22px; border-radius: 12px; background: #f4f7fb; border: 1px dashed var(--accent); color: var(--muted); text-align: center; font-weight: 600; }

    .intro-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 28px 24px;
      display: grid;
      gap: 12px;
      align-items: center;
      justify-items: center;
      text-align: center;
    }
    .intro-card h2 { margin: 0; font-size: 24px; }
    .intro-card p { margin: 0; color: var(--muted); }
    .btn-primary {
      padding: 13px 18px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-primary:hover { box-shadow: 0 12px 26px rgba(58, 134, 255, 0.28); transform: translateY(-1px); }

    .hidden { display: none !important; }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.38);
      padding: 16px;
      z-index: 10;
    }
    .modal-card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 22px 20px;
      text-align: center;
      max-width: 360px;
      width: 100%;
      border: 1px solid var(--border);
      display: grid;
      gap: 12px;
    }
    .modal-card h3 { margin: 0; font-size: 20px; }
    .modal-card p { margin: 0; color: var(--muted); }


    @media (max-width: 640px) {
      h1 { font-size: 28px; }
      .time-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <p class="kicker">12월 예약</p>
      <h1>최혁진과의 약속잡기</h1>
      <p class="lede">월~금 10:00~18:00 (30분 단위) · 링크를 공유해 다른 사람도 예약 가능</p>
    </header>

    <section id="notice" class="notice hidden">
      <h2>안내사항</h2>
      <ul>
        <li>예약 가능 기간: 12월 1일 ~ 12월 31일 (주말 제외)</li>
        <li>운영 시간: 10:00 ~ 18:00 (30분 간격, 점심시간 포함)</li>
        <li>예약 완료된 시간은 "예약완료"로 표시되어 선택할 수 없습니다.</li>
        <li>이 페이지 링크를 공유하면 다른 사람도 같은 화면에서 예약할 수 있습니다.</li>
      </ul>
    </section>

    <section id="intro" class="intro-card">
      <h2>12월 예약을 시작합니다</h2>
      <p>월~금, 30분 단위 시간대를 선택해 예약하세요.</p>
      <button id="startBtn" class="btn-primary" type="button">예약 시작하기</button>
    </section>

    <section id="card" class="card hidden">
      <div class="form-area">
        <label class="field">
          <span>예약일</span>
          <input type="date" id="dateInput" required>
          <small class="hint">12월 한 달 동안만 예약 가능합니다.</small>
        </label>

        <label class="field">
          <span>성명</span>
          <input type="text" id="nameInput" placeholder="이름을 입력하세요" required>
        </label>

        <label class="field">
          <span>인원수</span>
          <input type="number" id="peopleInput" min="1" max="30" value="1" required>
        </label>

        <button id="reserveBtn" type="button">예약하기</button>
        <div id="status" class="status" aria-live="polite"></div>
      </div>

      <div class="times-area">
        <div class="times-header">
          <div class="tag">시간 선택</div>
          <div class="day-label" id="dayLabel"></div>
        </div>
        <div id="timeGrid" class="time-grid"></div>
      </div>
    </section>
  </div>

  <div id="successModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3>예약이 완료되었습니다</h3>
      <p id="successText"></p>
      <button id="homeBtn" class="btn-primary" type="button">첫 화면으로 돌아가기</button>
    </div>
  </div>

  <script>
(() => {
  const year = new Date().getFullYear();
  const minDate = `${year}-12-01`;
  const maxDate = `${year}-12-31`;
  const apiBase = (() => {
    const origin = window.location.origin || '';
    if (origin.startsWith('http')) return `${origin}/api`;
    return 'http://localhost:3000/api'; // fallback when opened as file://
  })();

  const dateInput = document.getElementById('dateInput');
  const nameInput = document.getElementById('nameInput');
  const peopleInput = document.getElementById('peopleInput');
  const reserveBtn = document.getElementById('reserveBtn');
  const timeGrid = document.getElementById('timeGrid');
  const statusBox = document.getElementById('status');
  const dayLabel = document.getElementById('dayLabel');
  const intro = document.getElementById('intro');
  const card = document.getElementById('card');
  const notice = document.getElementById('notice');
  const startBtn = document.getElementById('startBtn');
  const successModal = document.getElementById('successModal');
  const successText = document.getElementById('successText');
  const homeBtn = document.getElementById('homeBtn');

  let selectedButtons = new Map();
  let selectedTimes = new Set();

  dateInput.min = minDate;
  dateInput.max = maxDate;

  const today = new Date();
  const defaultDate = (today.getMonth() === 11 && today.getFullYear() === year && today <= new Date(maxDate + 'T23:59:59'))
    ? formatDate(today)
    : minDate;
  dateInput.value = defaultDate;

  const baseTimes = buildTimes();

  renderSlots();
  showIntro();

  dateInput.addEventListener('change', () => { renderSlots(); });
  startBtn.addEventListener('click', showBooking);
  homeBtn.addEventListener('click', () => {
    hideModal();
    showIntro();
  });

  reserveBtn.addEventListener('click', async () => {
    const dateValue = dateInput.value;
    const dateObj = parseDate(dateValue);
    if (!dateValue || dateValue < minDate || dateValue > maxDate) {
      return setStatus('12월 날짜만 선택 가능합니다.', 'error');
    }
    if (!isWeekday(dateObj)) {
      return setStatus('월~금만 예약 가능합니다.', 'error');
    }
    if (selectedTimes.size === 0) {
      return setStatus('예약할 시간을 하나 이상 선택해주세요.', 'error');
    }
    if (!nameInput.value.trim() || !peopleInput.value) {
      return setStatus('성명과 인원수를 입력해주세요.', 'error');
    }

    reserveBtn.disabled = true;
    reserveBtn.textContent = '예약 처리 중...';

    const payload = {
      date: dateValue,
      timeSlots: Array.from(selectedTimes),
      name: nameInput.value.trim(),
      people: Number(peopleInput.value)
    };

    const result = await createReservation(payload);

    reserveBtn.disabled = false;
    reserveBtn.textContent = '예약하기';

    if (!result.ok) {
      if (result.conflict) {
        setStatus(`이미 예약된 시간: ${result.conflicts.join(', ')}`, 'error');
        renderSlots();
        return;
      }
      return setStatus(result.message || '예약 중 오류가 발생했습니다.', 'error');
    }

    const timesList = payload.timeSlots.sort().join(', ');
    setStatus(`${dateValue} ${timesList} 예약이 완료되었습니다.`, 'success');
    successText.textContent = `${dateValue} ${timesList} 예약이 완료되었습니다.`;
    clearSelection();
    await renderSlots();
    showModal();
  });

  function buildTimes() {
    const times = [];
    for (let hour = 10; hour < 18; hour++) {
      for (const minute of [0, 30]) {
        const label = `${String(hour).padStart(2, '0')}:${minute === 0 ? '00' : '30'}`;
        times.push({ label, type: 'slot' });
      }
    }
    return times;
  }

  async function renderSlots() {
    const dateValue = dateInput.value;
    const dateObj = parseDate(dateValue);
    clearSelection();
    statusBox.textContent = '';

    dayLabel.textContent = dateValue ? formatKoreanDate(dateObj) : '날짜를 선택하세요';

    timeGrid.innerHTML = '';

    if (!dateValue || dateValue < minDate || dateValue > maxDate) {
      return addEmptyState('12월 1일부터 12월 31일 사이만 선택할 수 있습니다.');
    }

    if (!isWeekday(dateObj)) {
      return addEmptyState('주말은 예약이 불가합니다. (월~금만 운영)');
    }

    let reserved = {};
    try {
      reserved = await fetchReservations(dateValue);
    } catch (e) {
      return addEmptyState('예약 정보를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
    }

    baseTimes.forEach((slot) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = slot.label;

      if (reserved[slot.label]) {
        btn.disabled = true;
        btn.classList.add('reserved');
        btn.textContent = `${slot.label} · 예약완료`;
      } else {
        btn.addEventListener('click', () => {
          if (selectedTimes.has(slot.label)) {
            selectedTimes.delete(slot.label);
            btn.classList.remove('selected');
            selectedButtons.delete(slot.label);
          } else {
            selectedTimes.add(slot.label);
            selectedButtons.set(slot.label, btn);
            btn.classList.add('selected');
          }
          setStatus('', '');
        });
      }

      timeGrid.appendChild(btn);
    });
  }

  function addEmptyState(message) {
    const wrap = document.createElement('div');
    wrap.className = 'empty-state';
    wrap.textContent = message;
    timeGrid.appendChild(wrap);
  }

  function setStatus(message, type) {
    statusBox.textContent = message;
    statusBox.className = 'status';
    if (type) {
      statusBox.classList.add(type);
    }
  }

  function formatDate(date) {
    return [
      date.getFullYear(),
      String(date.getMonth() + 1).padStart(2, '0'),
      String(date.getDate()).padStart(2, '0')
    ].join('-');
  }

  function parseDate(value) {
    const [y, m, d] = value.split('-').map(Number);
    return new Date(y, m - 1, d);
  }

  function formatKoreanDate(date) {
    if (!(date instanceof Date) || isNaN(date)) return '날짜를 선택하세요';
    const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
    return `${date.getMonth() + 1}월 ${date.getDate()}일 (${dayNames[date.getDay()]})`;
  }

  function isWeekday(date) {
    const day = date.getDay();
    return day >= 1 && day <= 5;
  }

  function showIntro() {
    intro.classList.remove('hidden');
    card.classList.add('hidden');
    notice.classList.add('hidden');
    statusBox.textContent = '';
    clearSelection();
  }

  function showBooking() {
    intro.classList.add('hidden');
    card.classList.remove('hidden');
    notice.classList.remove('hidden');
  }

  function showModal() {
    successModal.classList.remove('hidden');
  }

  function hideModal() {
    successModal.classList.add('hidden');
  }

  function clearSelection() {
    selectedTimes.clear();
    selectedButtons.forEach((btn) => btn.classList.remove('selected'));
    selectedButtons.clear();
  }

  async function fetchReservations(date) {
    const res = await fetch(`${apiBase}/reservations?date=${date}`);
    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error(text || '예약 정보 불러오기 실패');
    }
    const data = await res.json();
    return data.reservations || {};
  }

  async function createReservation(payload) {
    try {
      const res = await fetch(`${apiBase}/reservations`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.status === 409) {
        const data = await res.json().catch(() => ({}));
        return {
          ok: false,
          conflict: true,
          conflicts: data.conflicts || []
        };
      }

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        return {
          ok: false,
          message: data.message || '예약 중 오류가 발생했습니다.'
        };
      }

      return { ok: true };
    } catch (e) {
      return { ok: false, message: '네트워크 오류가 발생했습니다.' };
    }
  }
})();
  </script>
</body>
</html>
